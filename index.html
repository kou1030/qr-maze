<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学祭迷路ゲーム</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    #game { margin-top: 20px; }
    #timer { font-size: 18px; margin-top: 10px; }
    #inventory { margin-top: 20px; font-size: 16px; text-align: left; display: inline-block; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #cameraDiv { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; }
    #video { width:100%; height:100%; object-fit:cover; }
  </style>
</head>
<body>
  <h1>学祭迷路ゲーム</h1>
  <div id="timer">経過時間: 0分 0秒</div>
  <div id="game"></div>
  <div id="inventory"></div>

  <button onclick="openCamera()">カメラモード</button>

  <div id="cameraDiv">
    <video id="video" autoplay playsinline></video>
    <button style="position:absolute;top:10px;right:10px;z-index:1010;" onclick="closeCamera()">閉じる</button>
  </div>

  <script>
    // --- ゲーム状態 ---
    const gameDiv = document.getElementById("game");
    const timerDiv = document.getElementById("timer");
    const inventoryDiv = document.getElementById("inventory");

    let keywords = JSON.parse(localStorage.getItem('keywords') || '[]');
    let items = JSON.parse(localStorage.getItem('items') || '[]');
    let coins = parseInt(localStorage.getItem('coins') || '0');
    let startTime = parseInt(localStorage.getItem('startTime') || '0');
    let timerInterval;

    function updateInventory() {
      let html = "<h3>獲得アイテム・キーワード・コイン</h3><ul>";
      keywords.forEach(k => html += `<li>キーワード: ${k}</li>`);
      items.forEach(i => html += `<li>アイテム: ${i}</li>`);
      html += `<li>コイン: ${coins}</li></ul>`;
      inventoryDiv.innerHTML = html;
    }

    function updateTimer() {
      if(startTime){
        const elapsed = Math.floor((Date.now() - startTime)/1000);
        const minutes = Math.floor(elapsed/60);
        const seconds = elapsed%60;
        timerDiv.textContent = `経過時間: ${minutes}分 ${seconds}秒`;
      }
    }

    function startTimer() {
      startTime = Date.now();
      localStorage.setItem('startTime', startTime);

      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    }

    // --- ゲーム操作 ---
    function showQuiz(num) {
      if (num === "1") {
        gameDiv.innerHTML = `
          <h2>クイズ1</h2>
          <p>大学祭は何月に開催されることが多い？</p>
          <button onclick="answer(true)">10月〜11月</button>
          <button onclick="answer(false)">1月</button>`;
      } else if (num === "2") {
        gameDiv.innerHTML = `
          <h2>クイズ2</h2>
          <p>QRコードを発明したのはどこの国？</p>
          <button onclick="answer(true)">日本</button>
          <button onclick="answer(false)">アメリカ</button>`;
      } else if (num === "3") {
        gameDiv.innerHTML = `
          <h2>クイズ3</h2>
          <p>次のうちプログラミング言語はどれ？</p>
          <button onclick="answer(true)">JavaScript</button>
          <button onclick="answer(false)">Photoshop</button>`;
      }
      updateInventory();
    }

    function answer(correct) {
      if(correct){
        alert("正解！キーワードやアイテムを獲得しました🎉");
        const urlParams = new URLSearchParams(window.location.search);
        const qNum = urlParams.get("q");
        if(qNum==="1") keywords.push("祭の月");
        else if(qNum==="2") items.push("QRの知識");
        else if(qNum==="3") keywords.push("プログラミング");
        localStorage.setItem('keywords', JSON.stringify(keywords));
        localStorage.setItem('items', JSON.stringify(items));
        updateInventory();
        gameDiv.innerHTML = "<p>次のQRコードを探そう！</p>";
      } else alert("不正解…もう一度挑戦してみてね。");
    }

    function collectCoin() { coins++; localStorage.setItem('coins', coins); updateInventory(); alert("コイン獲得！"); }
    function collectItem(name){ if(!items.includes(name)) items.push(name); localStorage.setItem('items', JSON.stringify(items)); updateInventory(); alert(`アイテム「${name}」獲得！`); }

    function showGoal(){
      if(!keywords.includes("祭の月")) { gameDiv.innerHTML="<p>まだ必要なキーワードを集めていません！</p>"; updateInventory(); return; }
      clearInterval(timerInterval);
      updateTimer();
      gameDiv.innerHTML=`<h2>ゴール！</h2><p>クリアタイム: ${timerDiv.textContent}</p>`;
    }

    // --- カメラモード ---
    function openCamera(){
      document.getElementById("cameraDiv").style.display="block";
      navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
        .then(stream=>{ document.getElementById("video").srcObject=stream; });
    }

    function closeCamera(){
      const video=document.getElementById("video");
      if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
      document.getElementById("cameraDiv").style.display="none";
    }

    function handleQR(data){
      const params = new URLSearchParams(data.split("?")[1]);

      if(params.has("s")){
        // スタートQR: ゲーム初期化
        keywords=[]; items=[]; coins=0;
        localStorage.setItem('keywords', JSON.stringify(keywords));
        localStorage.setItem('items', JSON.stringify(items));
        localStorage.setItem('coins', coins);
        startTimer();
        updateInventory();
        alert("ゲームスタート！タイマーもリセットされました！");
      }
      if(params.has("coin")) collectCoin();
      if(params.has("item")) collectItem(params.get("item"));
      if(params.has("q")) showQuiz(params.get("q"));
      if(params.has("goal")) showGoal();
      closeCamera();
    }

    // --- ページ初期表示 ---
    updateInventory();
    if(localStorage.getItem('startTime')){
      startTime=parseInt(localStorage.getItem('startTime'));
      startTimer();
    } else gameDiv.innerHTML="<p>スタートQRを読み取ってゲームを始めてください</p>";

  </script>
</body>
</html>
