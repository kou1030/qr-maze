<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å­¦ç¥­è¿·è·¯ã‚²ãƒ¼ãƒ  </title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
      background: url("background1.png") no-repeat center top;
      background-size: cover;
      background-attachment: scroll;
      transition: background 0.5s ease; /* èƒŒæ™¯åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    }

    #game, #cameraMode {
      margin-top: 20px;
      position: relative;
    }

    #timer { position: fixed;   /* ç”»é¢ã«å›ºå®š */
             top: 20px;         /* ä¸Šã‹ã‚‰20px */
             left: 20px;       /* å³ã‹ã‚‰20px */
             font-size: 50px;
             color: white;      /* ç™½æ–‡å­—ï¼ˆèƒŒæ™¯ã«åˆã‚ã›ã¦å¤‰æ›´å¯ï¼‰ */
             background: rgba(0,0,0,0.0); /* åŠé€æ˜ã®èƒŒæ™¯ */
             padding: 5px 10px;
             border-radius: 6px;
             z-index: 1000; }
    #inventory {  position: fixed; top: 5px; right: 20px; font-size: 30px; text-align: left; display: inline-block; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #cameraMode video { width: 100%; max-width: 800px; border: 1px solid #333; }

    /* ã‚³ã‚¤ãƒ³ã‚¸ãƒ£ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .arCoin {
      position: absolute;
      width: 80px;
      height: 80px;
      animation: coinJump 1s ease-out forwards;
    }
    @keyframes coinJump {
      0% { transform: translateY(0) scale(0); opacity: 1; }
      50% { transform: translateY(-80px) scale(1.2); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 0; }
    }

    /* çŸ¢å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .arArrow {
      position: absolute;
      width: 80px;
      height: 80px;
      animation: arrowPop 1s ease-out forwards;
    }
    @keyframes arrowPop {
      0% { transform: scale(0); opacity: 1; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤®å›ºå®šãƒ»æœ€åˆã¯éè¡¨ç¤ºï¼‰ */
    .camera-btn {
      position: fixed;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 120px 120px;
      font-size: 24px;
      background: rgba(0,0,0,0.4);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: none; /* â† æœ€åˆã¯éè¡¨ç¤º */
      z-index: 999;
      opacity: 0;
    }

    .camera-btn:hover {
      background: rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>
  <h1>å­¦ç¥­è¿·è·¯ã‚²ãƒ¼ãƒ  </h1>
  <div id="timer"></div>

  <!-- èƒŒæ™¯åˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ˆä»»æ„ã§æ®‹ã™ï¼‰ -->
  <div>
    <button onclick="changeBackground('background1.png')">èƒŒæ™¯1</button>
    <button onclick="changeBackground('background2.png')">èƒŒæ™¯2</button>
    <button onclick="changeBackground('background3.png')">èƒŒæ™¯3</button>
  </div>

  <div>
    <button onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤®å›ºå®šãƒ»ã‚²ãƒ¼ãƒ é–‹å§‹ã§è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ -->
  <button id="cameraBtn" class="camera-btn" onclick="startCamera()">ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰</button>

  <div id="game">
    <p>ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å§‹ã‚ã¦ãã ã•ã„ï¼</p>
  </div>

  <div id="cameraMode" style="display:none;"></div>
  <div id="inventory"></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    let keywords = [];
    let items = [];
    let coins = 0;
    let startTime = 0;
    let timerInterval;
    let lastQR = "";

    const timerDiv = document.getElementById("timer");
    const gameDiv = document.getElementById("game");
    const cameraDiv = document.getElementById("cameraMode");
    const inventoryDiv = document.getElementById("inventory");

    function updateInventory() {
      let html = "<ul>";
      keywords.forEach(k => html += `<li>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${k}</li>`);
      items.forEach(i => html += `<li>ã‚¢ã‚¤ãƒ†ãƒ : ${i}</li>`);
      html += `<li>ã‚³ã‚¤ãƒ³: ${coins}</li></ul>`;
      inventoryDiv.innerHTML = html;
    }

    function updateTimer() {
      if(!startTime) return;
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      timerDiv.textContent =  ${minutes}: ${seconds}`;
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame(){
      changeBackground("background2.png");  // èƒŒæ™¯2ã«å¤‰æ›´

      keywords = [];
      items = [];
      coins = 0;
      startTime = Date.now();
      updateInventory();
      updateTimer();
      startTimer();
      gameDiv.innerHTML = "<p>ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ã§QRã‚’æ¢ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã‚³ã‚¤ãƒ³ã‚’ã‚²ãƒƒãƒˆã—ã‚ˆã†ï¼</p>";

      // ğŸ¯ ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      document.getElementById("cameraBtn").style.display = "block";
    }

    function collectCoin(x, y) {
      coins += 1;
      updateInventory();
      showCoinEffect("coin.png", x, y);
    }

    function showCoinEffect(imgSrc, x, y){
      const img = document.createElement("img");
      img.src = imgSrc;
      img.className = "arCoin";
      img.style.top = (y - 40) + "px";
      img.style.left = (x - 40) + "px";
      cameraDiv.appendChild(img);
      setTimeout(()=>{ cameraDiv.removeChild(img); }, 1000);
    }

    function showArrowEffect(imgSrc, x, y){
      const img = document.createElement("img");
      img.src = imgSrc;
      img.className = "arArrow";
      img.style.top = (y - 40) + "px";
      img.style.left = (x - 40) + "px";
      cameraDiv.appendChild(img);
      setTimeout(()=>{ cameraDiv.removeChild(img); }, 3000);
    }

    function showQuiz(num){
      let html = "";
      if(num === "1"){
        html = `<h2>ã‚¯ã‚¤ã‚º1</h2>
        <p>å¤§å­¦ç¥­ã¯ä½•æœˆï¼Ÿ</p>
        <button onclick="answer(true,1)">10æœˆã€œ11æœˆ</button>
        <button onclick="answer(false,1)">1æœˆ</button>`;
      }
      if(num === "2"){
        html = `<h2>ã‚¯ã‚¤ã‚º2</h2>
        <p>QRã‚³ãƒ¼ãƒ‰ç™ºæ˜å›½ã¯ï¼Ÿ</p>
        <button onclick="answer(true,2)">æ—¥æœ¬</button>
        <button onclick="answer(false,2)">ã‚¢ãƒ¡ãƒªã‚«</button>`;
      }
      if(num === "3"){
        html = `<h2>ã‚¯ã‚¤ã‚º3</h2>
        <p>ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã¯ï¼Ÿ</p>
        <button onclick="answer(true,3)">JavaScript</button>
        <button onclick="answer(false,3)">Photoshop</button>`;
      }
      gameDiv.innerHTML = html;
      cameraDiv.style.display = "none";
      gameDiv.style.display = "block";
    }

    function answer(correct, qNum){
      if(correct){
        alert("æ­£è§£ï¼ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç²å¾—ğŸ‰");
        if(qNum===1 && !keywords.includes("ç¥­ã®æœˆ")) keywords.push("ç¥­ã®æœˆ");
        if(qNum===2 && !items.includes("QRã®çŸ¥è­˜")) items.push("QRã®çŸ¥è­˜");
        if(qNum===3 && !keywords.includes("ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°")) keywords.push("ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°");
        updateInventory();
      } else {
        alert("ä¸æ­£è§£â€¦");
      }
      gameDiv.innerHTML = "<p>æ¬¡ã®QRã‚³ãƒ¼ãƒ‰ã‚’æ¢ãã†ï¼</p>";
      cameraDiv.style.display = "block";
      gameDiv.style.display = "none";
    }

    function startCamera(){
      gameDiv.style.display = "none";
      cameraDiv.style.display = "block";

      const video = document.createElement("video");
      video.setAttribute("autoplay","");
      video.setAttribute("playsinline","");
      cameraDiv.innerHTML = "";
      cameraDiv.appendChild(video);

      const closeBtn = document.createElement("button");
      closeBtn.textContent = "ã‚«ãƒ¡ãƒ©ã‚’é–‰ã˜ã‚‹";
      closeBtn.onclick = () => {
        if(video.srcObject){
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        cameraDiv.style.display = "none";
        gameDiv.style.display = "block";
      };
      cameraDiv.appendChild(closeBtn);

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => { video.srcObject = stream; })
        .catch(err => alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"));

      function scanQR(){
        if(video.readyState===video.HAVE_ENOUGH_DATA){
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
          if(code){ handleQR(code.data, code.location); }
        }
        requestAnimationFrame(scanQR);
      }
      scanQR();
    }

    function handleQR(data, location){
      if(data === lastQR) return;
      lastQR = data;
      setTimeout(()=>{ lastQR=""; }, 2000);

      const params = new URLSearchParams((data.split("?")[1]) || "");
      if(params.has("coin") && location){ 
        const x = (location.topLeftCorner.x + location.topRightCorner.x + location.bottomLeftCorner.x + location.bottomRightCorner.x)/4;
        const y = (location.topLeftCorner.y + location.topRightCorner.y + location.bottomLeftCorner.y + location.bottomRightCorner.y)/4;
        collectCoin(x, y);
      }
      if(params.has("q")){
        showQuiz(params.get("q"));
      }
      if(params.has("arrow") && location){
        const x = (location.topLeftCorner.x + location.topRightCorner.x + location.bottomLeftCorner.x + location.bottomRightCorner.x)/4;
        const y = (location.topLeftCorner.y + location.topRightCorner.y + location.bottomLeftCorner.y + location.bottomRightCorner.y)/4;
        showArrowEffect("arrow.png", x, y);
      }
    }

    // èƒŒæ™¯åˆ‡ã‚Šæ›¿ãˆé–¢æ•°ï¼ˆãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡ã¯å‰Šé™¤ï¼‰
    function changeBackground(imgName){
      document.body.style.background = `url(${imgName}) no-repeat center top`;
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundAttachment = "scroll";
    }

    window.addEventListener('load', () => {
      updateInventory();
      if(startTime) startTimer();
    });
  </script>
</body>
</html>

