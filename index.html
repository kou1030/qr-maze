<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>学祭迷路ゲーム AR版</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; }
  #game { position: relative; width: 100%; height: 100vh; background: #000; }
  video { width: 100%; height: 100%; object-fit: cover; }
  .overlay {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    transition: all 0.5s ease;
  }
  #inventory {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 16px;
    background: rgba(255,255,255,0.8);
    padding: 5px 10px;
    border-radius: 8px;
  }
</style>
</head>
<body>
  <div id="game"></div>
  <div id="inventory"></div>

<script>
const params = new URLSearchParams(window.location.search);
const gameDiv = document.getElementById("game");
const inventoryDiv = document.getElementById("inventory");

// ゲームデータ
let keywords = JSON.parse(localStorage.getItem('keywords') || '[]');
let items = JSON.parse(localStorage.getItem('items') || '[]');
let coins = parseInt(localStorage.getItem('coins') || '0');
let startTime = parseInt(localStorage.getItem('startTime') || '0');

// インベントリ更新
function updateInventory() {
  let html = "<h3>獲得アイテム・キーワード・コイン</h3><ul>";
  keywords.forEach(k => html += `<li>キーワード: ${k}</li>`);
  items.forEach(i => html += `<li>アイテム: ${i}</li>`);
  html += `<li>コイン: ${coins}</li></ul>`;
  inventoryDiv.innerHTML = html;
}

// カメラ映像を表示
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      const video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      gameDiv.appendChild(video);
    })
    .catch(err => alert("カメラが使えません: " + err));
}

// AR風エフェクト表示
function showOverlay(color = 'gold') {
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.style.width = '80px';
  overlay.style.height = '80px';
  overlay.style.background = color;
  overlay.style.top = `${Math.random() * (window.innerHeight-100)}px`;
  overlay.style.left = `${Math.random() * (window.innerWidth-100)}px`;
  gameDiv.appendChild(overlay);

  setTimeout(() => {
    overlay.style.transform = 'scale(2)';
    overlay.style.opacity = '0';
  }, 50);

  setTimeout(() => overlay.remove(), 700);
}

// コイン獲得
function collectCoin() {
  coins += 1;
  localStorage.setItem('coins', coins);
  updateInventory();
  showOverlay('gold');
  alert("コインを獲得しました🎉");
}

// アイテム獲得
function collectItem(name) {
  if(!items.includes(name)) items.push(name);
  localStorage.setItem('items', JSON.stringify(items));
  updateInventory();
  showOverlay('cyan');
  alert(`アイテム「${name}」を獲得しました🎉`);
}

// QRでゲーム開始
function startGame() {
  keywords = [];
  items = [];
  coins = 0;
  localStorage.setItem('keywords', JSON.stringify(keywords));
  localStorage.setItem('items', JSON.stringify(items));
  localStorage.setItem('coins', coins);

  startTime = Date.now();
  localStorage.setItem('startTime', startTime);
  updateInventory();
  startCamera();
}

// QRでゴール
function showGoal() {
  const elapsed = Math.floor((Date.now() - startTime)/1000);
  const minutes = Math.floor(elapsed/60);
  const seconds = elapsed%60;
  alert(`ゴール！クリアタイム: ${minutes}分 ${seconds}秒`);
}

// ルーティング
if(params.has('s')) startGame();
else if(params.has('coin')) collectCoin();
else if(params.has('item')) collectItem(params.get('item'));
else if(params.has('goal')) showGoal();
else updateInventory();
</script>
</body>
</html>
