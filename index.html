<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学祭迷路ゲーム AR版</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; }
    #camera { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    #game { position: relative; z-index: 2; margin-top: 20px; color: white; text-shadow: 1px 1px 2px black; }
    #timer { font-size: 18px; margin-top: 10px; position: relative; z-index: 2; color: white; text-shadow: 1px 1px 2px black; }
    #inventory { margin-top: 20px; font-size: 16px; text-align: left; display: inline-block; position: relative; z-index: 2; color: white; text-shadow: 1px 1px 2px black; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <div id="overlay"></div>
  <h1 id="title">学祭迷路ゲーム AR版</h1>
  <div id="game"></div>
  <div id="timer"></div>
  <div id="inventory"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const gameDiv = document.getElementById("game");
    const timerDiv = document.getElementById("timer");
    const inventoryDiv = document.getElementById("inventory");
    const overlayDiv = document.getElementById("overlay");

    // LocalStorage から読み込み
    let keywords = JSON.parse(localStorage.getItem('keywords') || '[]');
    let items = JSON.parse(localStorage.getItem('items') || '[]');
    let coins = parseInt(localStorage.getItem('coins') || '0');
    let startTime = parseInt(localStorage.getItem('startTime') || '0');
    let timerInterval;

    function updateInventory() {
      let html = "<h3>獲得アイテム・キーワード・コイン</h3><ul>";
      keywords.forEach(k => html += `<li>キーワード: ${k}</li>`);
      items.forEach(i => html += `<li>アイテム: ${i}</li>`);
      html += `<li>コイン: ${coins}</li>`;
      html += "</ul>";
      inventoryDiv.innerHTML = html;
    }

    function startTimer() {
      // ゲーム開始時にリセット
      keywords = [];
      items = [];
      coins = 0;
      localStorage.setItem('keywords', JSON.stringify(keywords));
      localStorage.setItem('items', JSON.stringify(items));
      localStorage.setItem('coins', coins);

      startTime = Date.now();
      localStorage.setItem('startTime', startTime);

      gameDiv.innerHTML = "<p>タイマーがスタートしました！迷路に挑戦！</p>";
      updateInventory();

      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerDiv.textContent = `経過時間: ${minutes}分 ${seconds}秒`;
      }, 1000);
    }

    function showQuiz(num) {
      if (num === "1") {
        gameDiv.innerHTML = `
          <h2>クイズ1</h2>
          <p>大学祭は何月に開催されることが多い？</p>
          <button onclick="answer(true)">10月〜11月</button>
          <button onclick="answer(false)">1月</button>
        `;
      } else if (num === "2") {
        gameDiv.innerHTML = `
          <h2>クイズ2</h2>
          <p>QRコードを発明したのはどこの国？</p>
          <button onclick="answer(true)">日本</button>
          <button onclick="answer(false)">アメリカ</button>
        `;
      } else if (num === "3") {
        gameDiv.innerHTML = `
          <h2>クイズ3</h2>
          <p>次のうちプログラミング言語はどれ？</p>
          <button onclick="answer(true)">JavaScript</button>
          <button onclick="answer(false)">Photoshop</button>
        `;
      }
      updateInventory();
    }

    function answer(correct) {
      if(correct){
        alert("正解！キーワードやアイテムを獲得しました🎉");
        const qNum = params.get("q");
        if(qNum === "1") keywords.push("祭の月");
        else if(qNum === "2") items.push("QRの知識");
        else if(qNum === "3") keywords.push("プログラミング");

        localStorage.setItem('keywords', JSON.stringify(keywords));
        localStorage.setItem('items', JSON.stringify(items));

        showEffect();
        updateInventory();
        gameDiv.innerHTML = "<p>次のQRコードを探そう！</p>";
      } else {
        alert("不正解…もう一度挑戦してみてね。");
      }
    }

    function collectCoin() {
      coins += 1;
      localStorage.setItem('coins', coins);
      showEffect();
      updateInventory();
      alert("コインを獲得しました🎉");
    }

    function collectItem(itemName) {
      if(!items.includes(itemName)) items.push(itemName);
      localStorage.setItem('items', JSON.stringify(items));
      showEffect();
      updateInventory();
      alert(`アイテム「${itemName}」を獲得しました🎉`);
    }

    function showGoal() {
      if(!keywords.includes("祭の月")){
        gameDiv.innerHTML = "<p>まだ必要なキーワードを集めていません！</p>";
        updateInventory();
        return;
      }

      clearInterval(timerInterval);
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      gameDiv.innerHTML = `<h2>ゴール！</h2><p>クリアタイム: ${minutes}分 ${seconds}秒</p>`;
      timerDiv.textContent = "";
      updateInventory();

      localStorage.removeItem('startTime');
    }

    // AR風エフェクト
    function showEffect() {
      const effect = document.createElement("div");
      effect.textContent = "✨";
      effect.style.position = "absolute";
      effect.style.fontSize = "50px";
      effect.style.left = Math.random() * 80 + "%";
      effect.style.top = Math.random() * 80 + "%";
      effect.style.opacity = 1;
      effect.style.transition = "all 1s ease-out";

      overlayDiv.appendChild(effect);

      setTimeout(() => {
        effect.style.top = (parseFloat(effect.style.top) - 20) + "%";
        effect.style.opacity = 0;
      }, 50);

      setTimeout(() => overlayDiv.removeChild(effect), 1000);
    }

    // カメラ起動
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { document.getElementById("camera").srcObject = stream; })
      .catch(err => console.error("カメラが使えません:", err));

    // ルーティング
    if(params.has("s")) startTimer();
    else if(params.has("q")) showQuiz(params.get("q"));
    else if(params.has("coin")) collectCoin();
    else if(params.has("item")) collectItem(params.get("item"));
    else if(params.has("goal")) showGoal();
    else {
      gameDiv.innerHTML = "<p>スタートQRを読み取ってゲームを始めてください</p>";
      updateInventory();
    }

  </script>
</body>
</html>
