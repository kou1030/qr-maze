<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学祭迷路ゲーム AR対応版</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    #game, #cameraMode { margin-top: 20px; position: relative; }
    #timer { font-size: 18px; margin-top: 10px; }
    #inventory { margin-top: 20px; font-size: 16px; text-align: left; display: inline-block; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #cameraMode video { width: 100%; max-width: 400px; border: 1px solid #333; }
    .arEffect { position: absolute; width: 80px; height: 80px; animation: pop 0.8s ease-out; }
    @keyframes pop {
      0% { transform: scale(0); opacity:1; }
      100% { transform: scale(1.5); opacity:0; }
    }
  </style>
</head>
<body>
  <h1>学祭迷路ゲーム AR対応版</h1>
  <div id="timer"></div>
  <div>
    <button onclick="startCamera()">カメラモード</button>
  </div>
  <div id="game">
    <p>スタート地点のQRコードを読み込んでゲームを開始してください！</p>
  </div>
  <div id="cameraMode" style="display:none;"></div>
  <div id="inventory"></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    // ゲームデータ初期化
    let keywords = JSON.parse(localStorage.getItem('keywords') || '[]');
    let items = JSON.parse(localStorage.getItem('items') || '[]');
    let coins = parseInt(localStorage.getItem('coins') || '0');
    let startTime = parseInt(localStorage.getItem('startTime') || '0');
    let timerInterval;
    let lastQR = ""; // 同じQR連続読み取り防止

    const timerDiv = document.getElementById("timer");
    const gameDiv = document.getElementById("game");
    const cameraDiv = document.getElementById("cameraMode");
    const inventoryDiv = document.getElementById("inventory");

    // 在庫表示
    function updateInventory() {
      let html = "<h3>獲得アイテム・キーワード・コイン</h3><ul>";
      keywords.forEach(k => html += `<li>キーワード: ${k}</li>`);
      items.forEach(i => html += `<li>アイテム: ${i}</li>`);
      html += `<li>コイン: ${coins}</li></ul>`;
      inventoryDiv.innerHTML = html;
    }

    // タイマー更新
    function updateTimer() {
      if(!startTime) return;
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      timerDiv.textContent = `経過時間: ${minutes}分 ${seconds}秒`;
    }

    // タイマー開始
    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }

    // スタートQR用リセット（完全リセット + タイマーゼロ + アイテム削除）
    function resetGame() {
      clearInterval(timerInterval);

      // localStorageの関連データを削除
      localStorage.removeItem('keywords');
      localStorage.removeItem('items');
      localStorage.removeItem('coins');
      localStorage.removeItem('startTime');

      // グローバル変数初期化
      keywords = [];
      items = [];
      coins = 0;
      startTime = Date.now(); // タイマーゼロから開始

      // 新しいデータ保存
      localStorage.setItem('keywords', JSON.stringify(keywords));
      localStorage.setItem('items', JSON.stringify(items));
      localStorage.setItem('coins', coins);
      localStorage.setItem('startTime', startTime);

      // 在庫表示・タイマー更新
      updateInventory();
      updateTimer();
      startTimer();

      // 前回読み取りQRリセット
      lastQR = "";

      // ゲーム画面更新
      gameDiv.innerHTML = "<p>新しいゲームがスタートしました！QRを探してアイテムやコインをゲット！</p>";
      cameraDiv.style.display = "none";
      gameDiv.style.display = "block";
    }

    function collectCoin() {
      coins += 1;
      localStorage.setItem('coins', coins);
      updateInventory();
      showAREffect("coin.png");
    }

    function collectItem(itemName) {
      if(!items.includes(itemName)) {
        items.push(itemName);
        localStorage.setItem('items', JSON.stringify(items));
        updateInventory();
        showAREffect("item.png");
      } else {
        alert("このアイテムはすでに持っています！");
      }
    }

    function showQuiz(num) {
      let html = "";
      if(num === "1") html = `<h2>クイズ1</h2><p>大学祭は何月？</p><button onclick="answer(true,1)">10月〜11月</button><button onclick="answer(false,1)">1月</button>`;
      if(num === "2") html = `<h2>クイズ2</h2><p>QRコード発明国は？</p><button onclick="answer(true,2)">日本</button><button onclick="answer(false,2)">アメリカ</button>`;
      if(num === "3") html = `<h2>クイズ3</h2><p>プログラミング言語は？</p><button onclick="answer(true,3)">JavaScript</button><button onclick="answer(false,3)">Photoshop</button>`;
      gameDiv.innerHTML = html;
    }

    function answer(correct, qNum){
      if(correct){
        alert("正解！アイテムやキーワードを獲得🎉");
        if(qNum===1 && !keywords.includes("祭の月")) keywords.push("祭の月");
        if(qNum===2 && !items.includes("QRの知識")) items.push("QRの知識");
        if(qNum===3 && !keywords.includes("プログラミング")) keywords.push("プログラミング");

        localStorage.setItem('keywords', JSON.stringify(keywords));
        localStorage.setItem('items', JSON.stringify(items));
        updateInventory();
        gameDiv.innerHTML = "<p>次のQRコードを探そう！</p>";
      } else { alert("不正解…"); }
    }

    function showAREffect(imgSrc){
      const img = document.createElement("img");
      img.src = imgSrc;
      img.className = "arEffect";
      img.style.top = Math.random()*200+"px";
      img.style.left = Math.random()*200+"px";
      cameraDiv.appendChild(img);
      setTimeout(()=>{ cameraDiv.removeChild(img); },800);
    }

    function startCamera(){
      gameDiv.style.display = "none";
      cameraDiv.style.display = "block";

      const video = document.createElement("video");
      video.setAttribute("autoplay","");
      video.setAttribute("playsinline","");
      cameraDiv.innerHTML = "";
      cameraDiv.appendChild(video);

      // カメラ閉じるボタン
      const closeBtn = document.createElement("button");
      closeBtn.textContent = "カメラを閉じる";
      closeBtn.onclick = () => {
        if(video.srcObject){
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        cameraDiv.style.display = "none";
        gameDiv.style.display = "block";
      };
      cameraDiv.appendChild(closeBtn);

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => { video.srcObject = stream; })
        .catch(err => alert("カメラにアクセスできません"));

      function scanQR(){
        if(video.readyState===video.HAVE_ENOUGH_DATA){
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
          if(code){ handleQR(code.data); }
        }
        requestAnimationFrame(scanQR);
      }
      scanQR();
    }

    function handleQR(data){
      // 同じQR連続読み取り防止
      if(data === lastQR) return;
      lastQR = data;
      setTimeout(()=>{ lastQR=""; }, 2000); // 2秒後にリセット

      const params = new URLSearchParams((data.split("?")[1]) || "");

      if(params.has("start")) { 
        resetGame(); 
        alert("スタート地点！新しいゲームを開始しました。"); 
        return; 
      }
      if(params.has("coin")) collectCoin();
      if(params.has("item")) collectItem(params.get("item"));
      if(params.has("q")) showQuiz(params.get("q"));
      if(params.has("goal")) { 
        clearInterval(timerInterval); 
        alert("ゴール到達！" + timerDiv.textContent); 
      }
    }

    // ページロード時
    window.addEventListener('load', () => {
      updateInventory();
      if(startTime) startTimer();
    });
  </script>
</body>
</html>
